# name: test/sql/zeek.test
# description: test zeek extension
# group: [sql]

require zeek

# Test basic read from gzipped file
query IIIII
SELECT ts, kuid, host_ip, conns_opened, conns_closed FROM read_zeek('data/known_hosts_20260116_00:00:00-01:00:00-0500.log.gz');
----
1768540789.230929	Kfoql5dpOG1K1	10.21.7.136	1	1

# Test count
query I
SELECT COUNT(*) FROM read_zeek('data/known_hosts_20260116_00:00:00-01:00:00-0500.log.gz');
----
1

# Test NULL handling for unset field (-)
query I
SELECT host_inner_vlan IS NULL FROM read_zeek('data/known_hosts_20260116_00:00:00-01:00:00-0500.log.gz');
----
true

# Test column types
query IIIII
SELECT typeof(ts), typeof(duration), typeof(host_vlan), typeof(conns_opened), typeof(kuid) FROM read_zeek('data/known_hosts_20260116_00:00:00-01:00:00-0500.log.gz');
----
DOUBLE	DOUBLE	BIGINT	UBIGINT	VARCHAR

# Test glob pattern - read all known_hosts files
query I
SELECT COUNT(*) FROM read_zeek('data/known_hosts*.gz');
----
27

# Test glob pattern with filename column
query I
SELECT COUNT(DISTINCT filename) FROM read_zeek('data/known_hosts*.gz', filename=true);
----
24

# Test filename column content
query I
SELECT filename FROM read_zeek('data/known_hosts_20260116_00:00:00-01:00:00-0500.log.gz', filename=true);
----
data/known_hosts_20260116_00:00:00-01:00:00-0500.log.gz

# Test vector[string] type - returns LIST
query I
SELECT annotations FROM read_zeek('data/known_hosts_20260116_00:00:00-01:00:00-0500.log.gz');
----
[foo, bar, baz]

# Test vector[string] and vector[interval] from dns.log
query II
SELECT answers, TTLs FROM read_zeek('data/dns.log.gz') LIMIT 1;
----
[vhost-account.vip.icann.org, 192.0.32.17]	[2735.0, 30.0]

# Test set[string] from dhcp.log
query I
SELECT uids FROM read_zeek('data/dhcp.log.gz');
----
[Cxkiqn3Sto5tM1CHA4, C1qMR61z0VQe1sDqYk]

# Test typeof for LIST columns
query II
SELECT typeof(annotations), typeof(TTLs) FROM read_zeek('data/known_hosts_20260116_00:00:00-01:00:00-0500.log.gz'), read_zeek('data/dns.log.gz') LIMIT 1;
----
VARCHAR[]	DOUBLE[]
